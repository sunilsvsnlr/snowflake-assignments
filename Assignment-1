--External Stage Creation
CREATE OR REPLACE TABLE PATIENT_REC_ASSIGNMENT1(
PATIENTID INT IDENTITY(1,1),
NAME VARCHAR,
AGE INT,
DIAGNOSIS VARCHAR,
MEDICALHISTORY VARIANT,
ADMISSIONDATE DATE DEFAULT NULL,
DISCHARGEDATE DATE DEFAULT NULL,
STATUS VARCHAR
);

CREATE OR REPLACE FILE FORMAT MY_CSV_FORMAT TYPE=CSV FIELD_OPTIONALLY_ENCLOSED_BY='"' SKIP_HEADER=1;

CREATE OR REPLACE STAGE RECORDS_STAGE URL='s3://client-snowflake-20240910/'
CREDENTIALS=(AWS_KEY_ID='' AWS_SECRET_KEY='') DIRECTORY = (ENABLE = TRUE);
 
 
COPY INTO HealthcareDB.Patients.PATIENT_REC_ASSIGNMENT1
FROM @RECORDS_STAGE FILE_FORMAT = (FORMAT_NAME = 'MY_CSV_FORMAT');

SELECT *FROM PATIENT_REC_ASSIGNMENT1;

--Create a materialized view:
CREATE MATERIALIZED VIEW AvgStayByDiagnosis AS
SELECT Diagnosis, AVG(DATEDIFF(DAY, AdmissionDate, DischargeDate)) AS
AvgStay
FROM PATIENT_REC_ASSIGNMENT1
GROUP BY Diagnosis;

--Query the materialized view:
SELECT * FROM AvgStayByDiagnosis;
